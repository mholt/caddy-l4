---
title: TLS Handler
---

# TLS Handler

## Summary

The TLS handler terminates TLS, i.e. all reads and writes performed with any handlers following it will now be
decrypted and encrypted.

This handler is one of the most frequently used handlers this package includes, but it's also known for having caused
some misunderstanding. It's crucial to keep in mind that the handler does *no* SSL certificates management, i.e. it
can't obtain or generate them - *you have to do it by means of configuring Caddy*. The only thing the handler does
is TLS termination using a set of SSL certificates *Caddy already has* and applying a set of connection policies.

## Syntax

The handler has `connection_policies` field which is a list of `caddytls.ConnectionPolicy` structures. It is an ordered
group of connection policies that govern the establishment of TLS connections. The first matching policy will be used
to configure TLS connections at handshake-time. If no policies are provided, the defaults apply. Please refer to
the [relevant Caddy docs](https://caddyserver.com/docs/json/apps/http/servers/tls_connection_policies/) for more info.
Note: the handler's syntax provides for *one* `connection_policies` in JSON, but *one or many* `connection_policy`
in Caddyfile.

The handler itself supports no [placeholders](https://caddyserver.com/docs/conventions#placeholders), but they may be supported at Caddy level for some connection policy
fields.

### Caddyfile

The handler supports the following syntax:
```caddyfile
# bare `tls` terminates TLS
# with the default connection policy
tls

# otherwise specify a custom set of connection policies
tls {
    connection_policy {
        # put connection policy options here
        # see Caddy documentation for more info
    }
    
    # two or more connection policies may be defined
    connection_policy {
        # put connection policy options here
    }
}
```

An example config of the Layer 4 app that ...:
```caddyfile
{
    layer4 {
        :443 {
            # terminate TLS traffic on TCP port 443
            # with ALPN HTTP/1 or HTTP/1.1,
            # apply the default connection policy,
            # then apply extra criteria to route HTTP traffic
            @h1 tls alpn http/1 http/1.1
            route @h1 {
                tls
                subroute {
                    @alpha http host alpha.example.com
                    route @alpha {
                        proxy alpha.machine.local:80
                    }
                    @beta http host beta.example.com
                    route @beta {
                        proxy beta.machine.local:80
                    }
                    route {
                        proxy gamma.machine.local:80
                    }
                }
            }
            
            # terminate TLS traffic on TCP port 443
            # with ALPN HTTP/2 and SNI alpha.example.com,
            # apply a custom connection policy,
            # proxy decrypted HTTP/2 traffic to alpha.machine.local:80
            # (the upstream must support processing such traffic)
            @h2a tls {
                alpn http/2
                sni alpha.example.com
            }
            route @h2a {
                tls {
                    connection_policy {
                        curves x25519
                        cert_selection {
                            serial_number 123456789012
                        }
                    }
                }
                proxy alpha.machine.local:80
            }
            
            # terminate TLS traffic on TCP port 443
            # with ALPN HTTP/2 and SNI beta.example.com,
            # apply a custom connection policy,
            # proxy decrypted HTTP/2 traffic to beta.machine.local:80
            # (the upstream must support processing such traffic)
            @h2b tls {
                alpn http/2
                sni beta.example.com
            }
            route @h2b {
                tls {
                    connection_policy {
                        curves secp256r1
                        cert_selection {
                            serial_number 123456789012
                        }
                    }
                }
                proxy beta.machine.local:80
            }
            
            # otherwise echo any bytes received on TCP port 443
            route {
                echo
            }
        }
    }
}

# the example config above is incomplete unless
# alpha.example.com and beta.example.com (or *.example.com)
# SSL certificates are obtained or generated by Caddy;
# it may be done by defining *.example.com HTTPS server block
```

### JSON

JSON equivalent to the caddyfile config provided above:
```json
{
    "apps": {
        "layer4": {
            "servers": {
                "srv0": {
                    "listen": [
                        ":443"
                    ],
                    "routes": [
                        {
                            "match": [
                                {
                                    "tls": {
                                        "alpn": [
                                            "http/1",
                                            "http/1.1"
                                        ]
                                    }
                                }
                            ],
                            "handle": [
                                {
                                    "handler": "tls"
                                },
                                {
                                    "handler": "subroute",
                                    "routes": [
                                        {
                                            "handle": [
                                                {
                                                    "handler": "proxy",
                                                    "upstreams": [
                                                        {
                                                            "dial": [
                                                                "alpha.machine.local:80"
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ],
                                            "match": [
                                                {
                                                    "http": [
                                                        {
                                                            "host": [
                                                                "alpha.example.com"
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        },
                                        {
                                            "handle": [
                                                {
                                                    "handler": "proxy",
                                                    "upstreams": [
                                                        {
                                                            "dial": [
                                                                "beta.machine.local:80"
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ],
                                            "match": [
                                                {
                                                    "http": [
                                                        {
                                                            "host": [
                                                                "beta.example.com"
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        },
                                        {
                                            "handle": [
                                                {
                                                    "handler": "proxy",
                                                    "upstreams": [
                                                        {
                                                            "dial": [
                                                                "gamma.machine.local:80"
                                                            ]
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "match": [
                                {
                                    "tls": {
                                        "alpn": [
                                            "http/2"
                                        ],
                                        "sni": [
                                            "alpha.example.com"
                                        ]
                                    }
                                }
                            ],
                            "handle": [
                                {
                                    "connection_policies": [
                                        {
                                            "certificate_selection": {
                                                "serial_number": [
                                                    "123456789012"
                                                ]
                                            },
                                            "curves": [
                                                "x25519"
                                            ]
                                        }
                                    ],
                                    "handler": "tls"
                                },
                                {
                                    "handler": "proxy",
                                    "upstreams": [
                                        {
                                            "dial": [
                                                "alpha.machine.local:80"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "match": [
                                {
                                    "tls": {
                                        "alpn": [
                                            "http/2"
                                        ],
                                        "sni": [
                                            "beta.example.com"
                                        ]
                                    }
                                }
                            ],
                            "handle": [
                                {
                                    "connection_policies": [
                                        {
                                            "certificate_selection": {
                                                "serial_number": [
                                                    "123456789012"
                                                ]
                                            },
                                            "curves": [
                                                "secp256r1"
                                            ]
                                        }
                                    ],
                                    "handler": "tls"
                                },
                                {
                                    "handler": "proxy",
                                    "upstreams": [
                                        {
                                            "dial": [
                                                "beta.machine.local:80"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        },
                        {
                            "handle": [
                                {
                                    "handler": "echo"
                                }
                            ]
                        }
                    ]
                }
            }
        }
    }
}
```
